name: Update Version Table in README

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest releases
        id: releases
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const stable = releases.data.find(r => !r.prerelease && !r.draft);
            const beta = releases.data.find(r => r.prerelease && !r.draft);

            return {
              stable: stable ? { tag: stable.tag_name, url: stable.html_url } : null,
              beta: beta ? { tag: beta.tag_name, url: beta.html_url } : null,
            };

      - name: Set version info
        run: |
          echo "STABLE_TAG=${{ fromJson(steps.releases.outputs.result).stable.tag }}" >> $GITHUB_ENV
          echo "STABLE_URL=${{ fromJson(steps.releases.outputs.result).stable.url }}" >> $GITHUB_ENV
          echo "BETA_TAG=${{ fromJson(steps.releases.outputs.result).beta.tag }}" >> $GITHUB_ENV
          echo "BETA_URL=${{ fromJson(steps.releases.outputs.result).beta.url }}" >> $GITHUB_ENV

      - name: Update README version table
        run: |
          VERSION_TABLE=$(cat <<EOF
| Channel       | Version       | Notes                         |
|---------------|---------------|-------------------------------|
| **Stable**    | [\`${STABLE_TAG}\`](${STABLE_URL}) | Recommended for most users    |
| **Beta**      | [\`${BETA_TAG}\`](${BETA_URL})     | Includes new features, may be less stable |
EOF
          )

          awk -v table="$VERSION_TABLE" '
            /<!-- versions:start -->/ { print; print table; skip=1; next }
            /<!-- versions:end -->/ { skip=0 }
            !skip
          ' README.md > README.tmp

          mv README.tmp README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "Update version table in README"
          git push