name: Update Version Table in README

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest releases
        id: releases
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const stable = releases.data.find(r => !r.prerelease && !r.draft);
            const beta = releases.data.find(r => r.prerelease && !r.draft);

            return {
              stableTag: stable?.tag_name ?? "N/A",
              stableUrl: stable?.html_url ?? "#",
              betaTag: beta?.tag_name ?? "N/A",
              betaUrl: beta?.html_url ?? "#"
            };

      - name: Set version info as env vars
        run: |
          echo "STABLE_TAG=${{ fromJson(steps.releases.outputs.result).stableTag }}" >> $GITHUB_ENV
          echo "STABLE_URL=${{ fromJson(steps.releases.outputs.result).stableUrl }}" >> $GITHUB_ENV
          echo "BETA_TAG=${{ fromJson(steps.releases.outputs.result).betaTag }}" >> $GITHUB_ENV
          echo "BETA_URL=${{ fromJson(steps.releases.outputs.result).betaUrl }}" >> $GITHUB_ENV

      - name: Update README with version table
        run: |
          TEMP_README=$(mktemp)

          {
            cat <<EOF
<!-- versions:start -->
| Channel       | Version       | Notes                         |
|---------------|---------------|-------------------------------|
| **Stable**    | [\`${STABLE_TAG}\`](${STABLE_URL}) | Recommended for most users    |
| **Beta**      | [\`${BETA_TAG}\`](${BETA_URL})     | Includes new features, may be less stable |
<!-- versions:end -->
EOF
          } > version_table.md

          awk '
            BEGIN { in_block=0 }
            /<!-- versions:start -->/ { print; while (getline line < "version_table.md") print line; in_block=1; next }
            /<!-- versions:end -->/ { in_block=0; next }
            !in_block
          ' README.md > "$TEMP_README"

          mv "$TEMP_README" README.md

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "Update version table in README"
          git push