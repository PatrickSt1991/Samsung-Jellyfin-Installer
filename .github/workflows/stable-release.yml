name: Stable Release

on:
  pull_request:
    branches: [master]
    types: [closed]

permissions:
  contents: write

env:
  PRODUCT_NAME: Jellyfin2Samsung
  PROJECT_DIR: Jellyfin2Samsung-CrossOS
  CONFIGURATION: Release

jobs:
  stable-release:
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'master' &&
      github.event.pull_request.head.ref == 'beta'
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout merged master
      # --------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Extract & validate version (NO -beta allowed)
      # --------------------------------------------------
      - name: Validate AppVersion (must be stable)
        shell: bash
        run: |
          FILE="${PROJECT_DIR}/Helpers/AppSettings.cs"

          VERSION_LINE=$(grep 'AppVersion' "$FILE")

          if echo "$VERSION_LINE" | grep -q '\-beta"'; then
            echo "âŒ AppVersion still contains '-beta'"
            echo "   Stable releases must use a clean version like v2.0.0.1"
            exit 1
          fi

          VERSION=$(echo "$VERSION_LINE" | grep -oE 'v[0-9]+(\.[0-9]+){1,3}')

          if [ -z "$VERSION" ]; then
            echo "âŒ Failed to extract stable version"
            exit 1
          fi

          echo "VERSION=${VERSION#v}" >> $GITHUB_ENV
          echo "VERSION_TAG=${VERSION}" >> $GITHUB_ENV

      # --------------------------------------------------
      # Guard: do not recreate existing stable release
      # --------------------------------------------------
      - name: Skip if stable release already exists
        shell: bash
        run: |
          if git tag --list | grep -qx "$VERSION_TAG"; then
            echo "â„¹ï¸ Stable release $VERSION_TAG already exists â€” skipping"
            exit 0
          fi

      # --------------------------------------------------
      # Generate changelog from last stable
      # --------------------------------------------------
      - name: Generate changelog
        shell: bash
        run: |
          LAST_STABLE=$(git tag \
            | grep -E '^v[0-9]+(\.[0-9]+){1,3}$' \
            | sort -V \
            | tail -n 1)

          if [ -z "$LAST_STABLE" ]; then
            RANGE="HEAD"
          else
            RANGE="$LAST_STABLE..HEAD"
          fi

          {
            echo "## âœ… What's New & Improved"
            git log $RANGE --pretty=format:"- %s"
          } > CHANGELOG.md

      # --------------------------------------------------
      # Prepare release notes
      # --------------------------------------------------
      - name: Prepare release notes
        shell: bash
        run: |
          DATE=$(date +'%Y-%m-%d')

          {
            echo "## ðŸ“¦ [${VERSION_TAG}] â€“ ${DATE}"
            echo ""
            cat CHANGELOG.md
            echo ""
            echo "---"
            echo ""
            echo "âš ï¸ **Platform Support Status**"
            echo ""
            echo "| Platform | Status | Notes |"
            echo "|----------|--------|-------|"
            echo "| ðŸŽ macOS | âœ… Stable | CI-built |"
            echo "| ðŸ§ Linux | âœ… Stable | CI-built |"
            echo "| ðŸªŸ Windows | âœ… Stable | CI-built |"
            echo ""
            echo "---"
            echo ""
            echo "### ðŸ›¡ï¸ Security Notice"
            echo "Antivirus warnings may occur and are likely **false positives**."
          } > RELEASE_NOTES.md

      # --------------------------------------------------
      # Setup .NET
      # --------------------------------------------------
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # --------------------------------------------------
      # Publish
      # --------------------------------------------------
      - name: Publish Windows
        run: dotnet publish -c $CONFIGURATION -r win-x64   -p:SelfContained=true -p:UseAppHost=true -o publish/win-x64

      - name: Publish macOS
        run: dotnet publish -c $CONFIGURATION -r osx-x64   -p:SelfContained=true -p:UseAppHost=true -o publish/osx-x64

      - name: Publish Linux
        run: dotnet publish -c $CONFIGURATION -r linux-x64 -p:SelfContained=true -p:UseAppHost=true -o publish/linux-x64

      # --------------------------------------------------
      # Package artifacts
      # --------------------------------------------------
      - name: Package artifacts
        shell: bash
        run: |
          mkdir -p dist

          (cd publish/win-x64 && zip -r "../../dist/${PRODUCT_NAME}-${VERSION_TAG}-win-x64.zip" .)
          tar -czf "dist/${PRODUCT_NAME}-${VERSION_TAG}-osx-x64.tar.gz"   -C publish/osx-x64 .
          tar -czf "dist/${PRODUCT_NAME}-${VERSION_TAG}-linux-x64.tar.gz" -C publish/linux-x64 .

      # --------------------------------------------------
      # Create GitHub Release (stable)
      # --------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: ${{ env.VERSION_TAG }}
          prerelease: false
          files: dist/*
          body_path: RELEASE_NOTES.md
