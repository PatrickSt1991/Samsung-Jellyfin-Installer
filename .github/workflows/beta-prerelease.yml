name: Beta Pre-Release

on:
  push:
    branches: [beta]

permissions:
  contents: write

env:
  PRODUCT_NAME: Jellyfin2Samsung
  PROJECT_DIR: Jellyfin2Samsung-CrossOS
  CONFIGURATION: Release

jobs:
  beta-release:
    runs-on: ubuntu-latest

    outputs:
      SKIP_RELEASE: ${{ env.SKIP_RELEASE }}
      VERSION: ${{ env.VERSION }}
      VERSION_TAG: ${{ env.VERSION_TAG }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        shell: bash
        run: |
          VERSION=$(curl -fsSL \
            https://raw.githubusercontent.com/Jellyfin2Samsung/Samsung-Jellyfin-Installer/refs/heads/beta/Jellyfin2Samsung-CrossOS/Helpers/AppSettings.cs \
            | grep -oE 'v[0-9]+(\.[0-9]+){1,3}')

          if [ -z "$VERSION" ]; then
            echo "âŒ Failed to extract version"
            exit 1
          fi

          echo "VERSION=${VERSION#v}" >> $GITHUB_ENV
          echo "VERSION_TAG=${VERSION}-beta" >> $GITHUB_ENV

      - name: Decide whether to skip beta release
        shell: bash
        run: |
          SKIP=false

          STABLE_TAG=$(git tag \
            | grep -E '^v[0-9]+(\.[0-9]+){1,3}$' \
            | sort -V \
            | tail -n 1)

          if [ -n "$STABLE_TAG" ] && [ "${STABLE_TAG#v}" = "$VERSION" ]; then
            echo "â„¹ï¸ Stable version $STABLE_TAG already exists â€” beta disabled"
            SKIP=true
          fi

          echo "SKIP_RELEASE=$SKIP" >> "$GITHUB_ENV"

      - name: Generate changelog
        if: env.SKIP_RELEASE != 'true'
        run: |
          LAST_TAG=$(git tag --sort=-creatordate | grep beta | head -n 1)
          RANGE="${LAST_TAG:+$LAST_TAG..HEAD}"

          {
            echo "## âœ… What's New & Improved"
            git log ${RANGE:-HEAD} --pretty=format:"- %s"
          } > CHANGELOG.md

      - name: Prepare release notes
        if: env.SKIP_RELEASE != 'true'
        run: |
          DATE=$(date +'%Y-%m-%d')
          {
            echo "## ðŸ“¦ [${VERSION_TAG}] â€“ ${DATE}"
            echo ""
            cat CHANGELOG.md
            echo ""
            echo "---"
            echo ""
            echo "| Platform | Status | Notes |"
            echo "|----------|--------|-------|"
            echo "| ðŸŽ macOS (.app + dmg) | âš ï¸ Beta | Native app |"
            echo "| ðŸŽ macOS (CLI) | âš ï¸ Beta | Tarball |"
            echo "| ðŸ§ Linux | âš ï¸ Beta | CI-built |"
            echo "| ðŸªŸ Windows | âš ï¸ Beta | CI-built |"
          } > RELEASE_NOTES.md

      - uses: actions/setup-dotnet@v4
        if: env.SKIP_RELEASE != 'true'
        with:
          dotnet-version: 8.0.x

      - name: Publish Windows
        if: env.SKIP_RELEASE != 'true'
        run: dotnet publish -c Release -r win-x64 -p:SelfContained=true -o publish/win-x64

      - name: Publish macOS CLI
        if: env.SKIP_RELEASE != 'true'
        run: dotnet publish -c Release -r osx-x64 -p:SelfContained=true -o publish/osx-x64

      - name: Publish Linux
        if: env.SKIP_RELEASE != 'true'
        run: dotnet publish -c Release -r linux-x64 -p:SelfContained=true -o publish/linux-x64

      - name: Package artifacts
        if: env.SKIP_RELEASE != 'true'
        run: |
          mkdir -p dist
          (cd publish/win-x64 && zip -r "../../dist/${PRODUCT_NAME}-${VERSION_TAG}-win-x64.zip" .)
          tar -czf "dist/${PRODUCT_NAME}-${VERSION_TAG}-osx-x64.tar.gz"   -C publish/osx-x64 .
          tar -czf "dist/${PRODUCT_NAME}-${VERSION_TAG}-linux-x64.tar.gz" -C publish/linux-x64 .

      - name: Create or Update GitHub Pre-Release
        if: env.SKIP_RELEASE != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: ${{ env.VERSION_TAG }}
          prerelease: true
          replace_existing_artifacts: true
          files: dist/*
          body_path: RELEASE_NOTES.md

  macos-app:
    runs-on: macos-latest
    needs: beta-release
    if: needs.beta-release.outputs.SKIP_RELEASE != 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Download icon
        run: curl -fsSL \
          https://raw.githubusercontent.com/Jellyfin2Samsung/Samsung-Jellyfin-Installer/beta/jellyfin.ico \
          -o jellyfin.ico

      - name: Convert ICO to ICNS
        run: |
          mkdir icon.iconset
          sips -z 16 16     jellyfin.ico --out icon.iconset/icon_16x16.png
          sips -z 32 32     jellyfin.ico --out icon.iconset/icon_16x16@2x.png
          sips -z 128 128   jellyfin.ico --out icon.iconset/icon_128x128.png
          sips -z 256 256   jellyfin.ico --out icon.iconset/icon_128x128@2x.png
          sips -z 512 512   jellyfin.ico --out icon.iconset/icon_512x512.png
          sips -z 1024 1024 jellyfin.ico --out icon.iconset/icon_512x512@2x.png
          iconutil -c icns icon.iconset -o jellyfin.icns

      - name: Publish macOS binary
        run: dotnet publish -c Release -r osx-x64 -p:SelfContained=true -o publish/osx-app

      - name: Create .app bundle
        run: |
          APP_NAME="Jellyfin2Samsung"
          APP_DIR="${APP_NAME}.app/Contents"

          mkdir -p "$APP_DIR/MacOS" "$APP_DIR/Resources"
          cp publish/osx-app/${APP_NAME} "$APP_DIR/MacOS/${APP_NAME}"
          cp jellyfin.icns "$APP_DIR/Resources/"
          chmod +x "$APP_DIR/MacOS/${APP_NAME}"

          cat > "$APP_DIR/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key><string>${APP_NAME}</string>
            <key>CFBundleExecutable</key><string>${APP_NAME}</string>
            <key>CFBundleIconFile</key><string>jellyfin</string>
            <key>CFBundleIdentifier</key><string>org.jellyfin.${APP_NAME}</string>
            <key>CFBundleVersion</key><string>${{ needs.beta-release.outputs.VERSION }}</string>
            <key>CFBundlePackageType</key><string>APPL</string>
            <key>LSMinimumSystemVersion</key><string>11.0</string>
          </dict>
          </plist>
          EOF

      - name: Ad-hoc codesign
        run: codesign --deep --force --sign - Jellyfin2Samsung.app

      - name: Create DMG
        run: |
          APP_NAME="Jellyfin2Samsung"
          DMG_NAME="${PRODUCT_NAME}-${{ needs.beta-release.outputs.VERSION_TAG }}-macos.dmg"

          mkdir -p dist dmg
          cp -R "${APP_NAME}.app" dmg/

          hdiutil create \
            -volname "${APP_NAME}" \
            -srcfolder dmg \
            -ov \
            -format UDZO \
            "dist/${DMG_NAME}"

      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.beta-release.outputs.VERSION_TAG }}
          files: dist/*
