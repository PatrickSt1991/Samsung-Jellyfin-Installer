name: Beta Pre-Release

on:
  push:
    branches: [beta]

permissions:
  contents: write

env:
  PRODUCT_NAME: Jellyfin2Samsung
  PROJECT_DIR: Jellyfin2Samsung-CrossOS
  CONFIGURATION: Release

jobs:
# ======================================================
# RELEASE + WINDOWS + LINUX
# ======================================================
  beta-release:
    runs-on: ubuntu-latest

    outputs:
      SKIP_RELEASE: ${{ env.SKIP_RELEASE }}
      VERSION: ${{ env.VERSION }}
      VERSION_TAG: ${{ env.VERSION_TAG }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        shell: bash
        run: |
          VERSION=$(grep -oE 'v[0-9]+(\.[0-9]+){1,3}' \
            Jellyfin2Samsung-CrossOS/Helpers/AppSettings.cs)

          [ -z "$VERSION" ] && exit 1
          echo "VERSION=${VERSION#v}" >> $GITHUB_ENV
          echo "VERSION_TAG=${VERSION}-beta" >> $GITHUB_ENV

      - name: Decide skip
        run: |
          SKIP=false
          STABLE=$(git tag | grep -E '^v[0-9]' | sort -V | tail -n1)
          [ "${STABLE#v}" = "$VERSION" ] && SKIP=true
          echo "SKIP_RELEASE=$SKIP" >> $GITHUB_ENV

      - uses: actions/setup-dotnet@v4
        if: env.SKIP_RELEASE != 'true'
        with:
          dotnet-version: 8.0.x

      # ---------------- WINDOWS ----------------
      - name: Build Windows
        if: env.SKIP_RELEASE != 'true'
        run: |
          dotnet publish Jellyfin2Samsung-CrossOS/Jellyfin2Samsung.csproj \
            -c Release -r win-x64 -p:SelfContained=true -o publish/win-x64
          (cd publish/win-x64 && zip -r "../../dist/${PRODUCT_NAME}-${VERSION_TAG}-win-x64.zip" .)

      # ---------------- LINUX ----------------
      - name: Build Linux
        if: env.SKIP_RELEASE != 'true'
        run: |
          dotnet publish Jellyfin2Samsung-CrossOS/Jellyfin2Samsung.csproj \
            -c Release -r linux-x64 -p:SelfContained=true -o publish/linux-x64
          tar -czf "dist/${PRODUCT_NAME}-${VERSION_TAG}-linux-x64.tar.gz" -C publish/linux-x64 .

      # ---------------- LINUX ICON ----------------
      - name: Linux icon
        if: env.SKIP_RELEASE != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin
          rsvg-convert -w 256 -h 256 jellyfin-tizen-logo.svg -o jellyfin.png

      # ---------------- DEB ----------------
      - name: Build .deb
        if: env.SKIP_RELEASE != 'true'
        run: |
          sudo apt-get install -y dpkg-dev
          PKG=deb/opt/jellyfin2samsung
          mkdir -p $PKG deb/usr/share/{applications,icons/hicolor/256x256/apps}
          cp publish/linux-x64/Jellyfin2Samsung $PKG/
          chmod +x $PKG/Jellyfin2Samsung
          cp jellyfin.png deb/usr/share/icons/hicolor/256x256/apps/jellyfin2samsung.png

          cat > deb/usr/share/applications/jellyfin2samsung.desktop <<EOF
          [Desktop Entry]
          Name=Jellyfin2Samsung
          Exec=/opt/jellyfin2samsung/Jellyfin2Samsung
          Icon=jellyfin2samsung
          Type=Application
          Categories=Utility;
          EOF

          mkdir -p deb/DEBIAN
          cat > deb/DEBIAN/control <<EOF
          Package: jellyfin2samsung
          Version: ${VERSION}
          Architecture: amd64
          Maintainer: Jellyfin
          Description: Jellyfin Samsung Installer
          EOF

          dpkg-deb --build deb
          mv deb.deb dist/${PRODUCT_NAME}-${VERSION_TAG}-linux-x64.deb

      # ---------------- APPIMAGE ----------------
      - name: Build AppImage
        if: env.SKIP_RELEASE != 'true'
        run: |
          mkdir -p AppDir/usr/bin
          cp publish/linux-x64/Jellyfin2Samsung AppDir/usr/bin/
          chmod +x AppDir/usr/bin/Jellyfin2Samsung
          cp jellyfin.png AppDir/jellyfin2samsung.png

          cat > AppDir/jellyfin2samsung.desktop <<EOF
          [Desktop Entry]
          Name=Jellyfin2Samsung
          Exec=Jellyfin2Samsung
          Icon=jellyfin2samsung
          Type=Application
          Categories=Utility;
          EOF

          curl -fsSL https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -o appimagetool
          chmod +x appimagetool
          ./appimagetool AppDir dist/${PRODUCT_NAME}-${VERSION_TAG}-linux-x64.AppImage

      # ---------------- RELEASE ----------------
      - uses: softprops/action-gh-release@v2
        if: env.SKIP_RELEASE != 'true'
        with:
          tag_name: ${{ env.VERSION_TAG }}
          prerelease: true
          files: dist/*

# ======================================================
# MACOS (UNIVERSAL GUI + CLI)
# ======================================================
  macos-app:
    runs-on: macos-latest
    needs: beta-release
    if: needs.beta-release.outputs.SKIP_RELEASE != 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # ICON
      - run: |
          sips -s format png jellyfin-tizen-logo.svg --out jellyfin.png
          sips -z 1024 1024 jellyfin.png --out jellyfin.png
          mkdir icon.iconset
          for s in 16 32 128 256 512; do
            sips -z $s $s jellyfin.png --out icon.iconset/icon_${s}x${s}.png
            sips -z $((s*2)) $((s*2)) jellyfin.png --out icon.iconset/icon_${s}x${s}@2x.png
          done
          iconutil -c icns icon.iconset -o jellyfin.icns

      # BUILD BOTH ARCHS
      - run: dotnet publish Jellyfin2Samsung-CrossOS/Jellyfin2Samsung.csproj -c Release -r osx-arm64 -p:SelfContained=true -o arm
      - run: dotnet publish Jellyfin2Samsung-CrossOS/Jellyfin2Samsung.csproj -c Release -r osx-x64   -p:SelfContained=true -o x64

      # UNIVERSAL
      - run: |
          lipo -create arm/Jellyfin2Samsung x64/Jellyfin2Samsung -output Jellyfin2Samsung
          chmod +x Jellyfin2Samsung

      # APP
      - run: |
          APP=Jellyfin2Samsung.app/Contents
          mkdir -p $APP/{MacOS,Resources}
          cp Jellyfin2Samsung $APP/MacOS/
          cp jellyfin.icns $APP/Resources/

      - run: codesign --deep --force --sign - Jellyfin2Samsung.app

      # DMG
      - run: |
          mkdir dmg dist
          cp -R Jellyfin2Samsung.app dmg/
          ln -s /Applications dmg/Applications
          hdiutil create -volname Jellyfin2Samsung -srcfolder dmg -format UDZO dist/${PRODUCT_NAME}-${{ needs.beta-release.outputs.VERSION_TAG }}-macos.dmg

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.beta-release.outputs.VERSION_TAG }}
          files: dist/*
